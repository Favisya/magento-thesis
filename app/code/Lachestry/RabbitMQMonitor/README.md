# Lachestry RabbitMQ Monitor

Модуль для мониторинга и тестирования RabbitMQ консьюмеров в Magento 2.

## Возможности

1. Страница в админке для мониторинга статуса RabbitMQ консьюмеров
2. CLI команда для отправки тестовых сообщений в очереди
3. Скрипт для настройки топиков RabbitMQ в env.php

## Установка

### Установка модуля

```bash
# Из корня Magento 2
bin/magento setup:upgrade
bin/magento setup:di:compile
bin/magento setup:static-content:deploy -f
bin/magento cache:clean
```

### Настройка топиков RabbitMQ

В Magento 2 топики RabbitMQ должны быть настроены для корректной работы с очередями. Модуль включает скрипт для автоматической настройки топиков.

```bash
# Из корня Magento 2
php -f app/code/Lachestry/RabbitMQMonitor/Setup/installTopics.php
```

Скрипт добавит все необходимые топики в ваш файл `app/etc/env.php` и создаст резервную копию оригинального файла.

## Использование

### Мониторинг консьюмеров в админке

После установки модуля, вы можете перейти в раздел:

**System → RabbitMQ Monitor → Consumers Status**

Здесь отображается список всех консьюмеров с их текущим статусом и временем последней обработки сообщения.

### Отправка тестовых сообщений

Для отправки тестовых сообщений в очереди RabbitMQ, используйте CLI-команду:

```bash
# Просмотр списка доступных топиков и консьюмеров
bin/magento rabbitmq:test:message --list

# Отправка тестового сообщения в конкретный топик
bin/magento rabbitmq:test:message <название_топика>

# Отправка тестового сообщения для конкретного консьюмера
bin/magento rabbitmq:test:message --consumer=<название_консьюмера>

# Отправка кастомного сообщения
bin/magento rabbitmq:test:message <название_топика> --message="Текст сообщения"
```

## Статусы консьюмеров

- **Running** - консьюмер запущен и активно обрабатывает сообщения
- **Stopped** - консьюмер остановлен
- **Disabled** - консьюмер отключен в конфигурации

## Настройка запуска консьюмеров через cron

Для автоматического запуска консьюмеров через cron, убедитесь что в вашем `env.php` настроен раздел `cron_consumers_runner`:

```php
'cron_consumers_runner' => [
    'cron_run' => true,
    'max_messages' => 1000,
    'consumers' => [
        'product_action_attribute.update',
        'inventory.mass.update',
        // другие необходимые консьюмеры
    ]
],
```

## Дополнительная информация

- Если консьюмер не обрабатывает сообщения, проверьте его статус в модуле мониторинга
- Используйте CLI-команду `bin/magento queue:consumers:start <название_консьюмера>` для ручного запуска консьюмера
- Для отладки проблем с очередями, проверьте логи в `var/log/` 