# Lachestry Test Module

## Что такое тесты и почему они важны

Тестирование - это процесс проверки программного обеспечения с целью выявления ошибок, убеждения в его корректной работе и соответствии требованиям. Автоматизированное тестирование позволяет:

1. **Обнаруживать ошибки на ранних этапах разработки** - тесты помогают найти проблемы до того, как они попадут в производство
2. **Обеспечивать стабильность кода** - после изменений тесты подтверждают, что существующий функционал продолжает работать
3. **Служить документацией** - тесты показывают, как должен работать код и какие сценарии использования предусмотрены
4. **Улучшать архитектуру кода** - необходимость тестирования стимулирует создание более модульного и слабосвязанного кода
5. **Ускорять разработку** - в долгосрочной перспективе тесты экономят время на отладке и исправлении ошибок

### Типы тестирования

В проекте Magento могут использоваться различные типы тестов:

1. **Модульные (Unit) тесты** - проверяют изолированные части кода, обычно отдельные классы
2. **Интеграционные тесты** - проверяют взаимодействие нескольких компонентов системы
3. **Функциональные тесты** - проверяют соответствие функциональности требованиям
4. **Нагрузочные тесты** - проверяют производительность системы под нагрузкой
5. **Тесты безопасности** - проверяют устойчивость системы к атакам

В модуле `Lachestry_Test` основное внимание уделяется **модульным (Unit) тестам**.

### Модульное тестирование в PHP

Модульное тестирование в PHP осуществляется с помощью фреймворка PHPUnit. Основные концепции:

- **Тестовый класс** - класс, содержащий тестовые методы, наследуется от `PHPUnit\Framework\TestCase`
- **Тестовый метод** - метод, проверяющий конкретную функциональность, обычно начинается с префикса `test`
- **Утверждения (assertions)** - методы для проверки ожидаемых и фактических результатов (`assertEquals`, `assertTrue`, и т.д.)
- **Фикстуры** - методы `setUp()` и `tearDown()` для подготовки и очистки тестового окружения
- **Моки и стабы** - объекты, имитирующие поведение реальных зависимостей

## Обзор

Модуль `Lachestry_Test` предоставляет инфраструктуру для запуска юнит-тестов в проекте Magento 2. Он включает в себя консольные команды, конфигурацию PHPUnit и фреймворк для написания и выполнения тестов.

## Существующие тесты

### 1. Configuration (ConfigTest)
- **getConfigValue** - Проверка получения значения конфигурации с указанными scope и scopeId
- **getConfigValueWithDefaultScope** - Проверка получения значения конфигурации с дефолтным scope
- **getConfigValueNull** - Проверка получения пустой строки при отсутствии значения конфигурации
- **isEnabled** - Проверка метода isEnabled когда модуль включен
- **isDisabled** - Проверка метода isEnabled когда модуль выключен

### 2. CronMonitoring (CronMonitoringTest)
- **checkCronStatus** - Проверка получения статуса крон-задач
- **getFailedJobs** - Проверка получения списка проблемных крон-задач
- **getFailedJobsEmpty** - Проверка получения пустого списка неудачных крон-задач

### 3. Cron (CronJobTest)
- **execute** - Проверка выполнения крон-задачи при включенном модуле
- **executeDisabled** - Проверка пропуска выполнения крон-задачи при выключенном модуле

### 4. LogMonitor (LogMonitorTest)
- **checkLogForErrors** - Проверка нахождения ошибок в лог-файле
- **checkLogForErrorsEmptyLog** - Проверка работы с пустым лог-файлом
- **checkLogForErrorsNonExistentLog** - Проверка работы с несуществующим лог-файлом
- **clearLog** - Проверка очистки лог-файла
- **clearLogNonExistentFile** - Проверка попытки очистки несуществующего лог-файла

### 5. Notifier (NotificationTest)
- **testSendNotificationSuccess** - Проверка успешной отправки уведомления
- **testSendNotificationWhenDisabled** - Проверка отправки уведомления при отключенном модуле
- **testSendNotificationWithoutChatId** - Проверка отправки уведомления без настроенного chat_id
- **testSendNotificationFailure** - Проверка обработки ошибки при отправке уведомления

### 6. ProcessMonitor (ProcessMonitorTest)
- **testCheckProcessWhenProcessExists** - Проверка обнаружения существующего процесса
- **testCheckProcessWhenProcessDoesNotExist** - Проверка корректной обработки отсутствующего процесса
- **testCheckProcessWhenCommandFails** - Проверка обработки ошибок при выполнении команды
- **testGetProcessInfoWithValidProcess** - Проверка получения детальной информации о существующем процессе
- **testGetProcessInfoWithNoProcesses** - Проверка получения информации при отсутствии процессов
- **testGetProcessInfoWhenCommandFails** - Проверка обработки ошибок при получении информации о процессе
- **testGetProcessInfoWithInvalidFormat** - Проверка обработки некорректного формата вывода
- **testGetProcessInfoWithSpecialCharacters** - Проверка работы с процессами, содержащими специальные символы
- **testCheckProcessWithSpecialCharacters** - Проверка поиска процессов с специальными символами

### 7. RabbitMQMonitor (RabbitMQMonitorTest)
- **testCheckQueueStatusWithValidQueue** - Проверка получения статуса существующей очереди
- **testCheckQueueStatusWithInvalidResponse** - Проверка обработки некорректного ответа от RabbitMQ
- **testCheckQueueStatusWithCommandFailure** - Проверка обработки ошибок при выполнении команды
- **testCheckQueueStatusWithHttpError** - Проверка обработки HTTP-ошибок от API
- **testCheckQueueStatusWithTimeout** - Проверка обработки таймаутов при запросе
- **testPurgeQueueSuccess** - Проверка успешной очистки очереди
- **testPurgeQueueFailure** - Проверка обработки ошибок при очистке очереди
- **testPurgeQueueWithTimeout** - Проверка обработки таймаутов при очистке очереди

### 8. Telegram (TelegramClientTest)
- **sendMessageSuccess** - Проверка успешной отправки сообщения в Telegram
- **sendMessageFailure** - Проверка неудачной отправки сообщения
- **sendMessageInvalidResponse** - Проверка обработки неверного формата ответа 
- **sendMessageEmptyResponse** - Проверка обработки пустого ответа
- **sendMessageNonArrayResponse** - Проверка обработки ответа в неверном формате

### 9. Telegram API (TelegramProviderTest)
- **sendMessage** - Проверка отправки сообщения через API Telegram
- **sendMessageToAllChats** - Проверка отправки сообщения всем активным чатам
- **getMessages** - Проверка получения сообщений через API Telegram
- **getMessagesEmptyResponse** - Проверка обработки пустого ответа при получении сообщений

### CronJob Tests
- `testExecuteWhenDisabled` - проверяет, что при отключенной конфигурации не выполняются никакие проверки
- `testExecuteWithNoIssues` - проверяет выполнение без обнаружения проблем
- `testExecuteWithLogErrors` - проверяет обработку ошибок в логах
- `testExecuteWithProcessIssues` - проверяет обработку проблем с процессами
- `testExecuteWithRabbitMQIssues` - проверяет обработку проблем с очередями RabbitMQ

## Общая статистика
- **Всего модулей с тестами**: 9
- **Общее количество тестов**: 35
- **Общее количество утверждений**: 78
- **Последние обновления**:
  - Добавлены тесты для обработки HTTP-ошибок в RabbitMQMonitor
  - Улучшена обработка ошибок в ProcessMonitor
  - Добавлены тесты для специальных символов в именах процессов
  - Улучшена обработка таймаутов в RabbitMQMonitor

## Инструменты тестирования

### Моки и вспомогательные классы
- **FileMock** - Специальный мок для работы с файлами, обходит ограничения стандартного мокинга
- **CommandRendererInterface** - Интерфейс для рендеринга команд shell
- **Shell** - Мок для выполнения shell-команд

## Принципы тестирования

### 1. FIRST
Хорошие тесты следуют принципам FIRST:
- **Fast** - тесты должны выполняться быстро
- **Independent** - тесты не должны зависеть друг от друга
- **Repeatable** - тесты должны давать одинаковый результат при каждом запуске
- **Self-validating** - тесты должны сами определять, прошли они или нет
- **Timely** - тесты должны писаться до или одновременно с кодом

### 2. Паттерн AAA (Arrange-Act-Assert)
Каждый тест должен следовать паттерну:
- **Arrange** - подготовка данных и окружения для теста
- **Act** - выполнение тестируемого действия
- **Assert** - проверка результатов

### 3. Изоляция
Юнит-тесты должны тестировать только одну единицу кода, изолируя её от зависимостей с помощью моков и стабов.

## Специфика тестирования в Magento 2

При тестировании кода Magento 2 следует учитывать:

1. **Dependency Injection** - Magento 2 использует DI, что облегчает тестирование с использованием моков
2. **ObjectManager** - в тестах можно использовать ObjectManager для инстанцирования объектов
3. **Интерфейсы** - Magento 2 активно использует интерфейсы, что упрощает создание моков
4. **Области видимости (scopes)** - необходимо тестировать функциональность с учетом разных областей видимости (website, store, store view)
5. **Плагины и события** - необходимо учитывать влияние плагинов и событий на тестируемый код

## Функциональность

- Запуск юнит-тестов для отдельных модулей или всего проекта
- Удобный вывод результатов тестирования в читаемом формате
- Опциональное покрытие кода и отчеты
- Интеграция с существующими магазинами и базами данных
- Поддержка тестирования shell-команд и внешних API
- Обработка различных сценариев ошибок и исключений

## Установка

Модуль устанавливается автоматически вместе с основным проектом Lachestry. Дополнительной установки не требуется.

## Использование

### Запуск тестов через командную строку

#### Запуск всех тестов

```bash
bin/magento lachestry:test:run --all
```

#### Запуск тестов для конкретного модуля

```bash
bin/magento lachestry:test:run --module Telegram
```

#### Запуск конкретного теста

```bash
bin/magento lachestry:test:run --test TelegramClientTest
```

#### Отчет о покрытии кода

```bash
bin/magento lachestry:test:run --all --coverage
```

#### Отладочная информация

```bash
bin/magento lachestry:test:run --all --debug
```

### Опции командной строки

| Опция       | Сокращение | Описание                                      |
|-------------|------------|-----------------------------------------------|
| `--module`  | `-m`       | Модуль для тестирования                       |
| `--test`    | `-t`       | Конкретный тест для запуска                   |
| `--all`     | `-a`       | Запуск всех тестов                            |
| `--coverage`| `-c`       | Генерировать отчет о покрытии кода            |
| `--debug`   | `-d`       | Вывод отладочной информации                   |
| `--testdox` | нет        | Вывод тестов в удобочитаемом формате          |

## Структура тестов

### Размещение тестов

Тесты для каждого модуля должны быть размещены в директории `Test/Unit` внутри соответствующего модуля. Например:

```
app/code/Lachestry/
  ├── Telegram/
  │   ├── Model/
  │   └── Test/
  │       └── Unit/
  │           └── Model/
  │               ├── TelegramClientTest.php
  │               └── Api/
  │                   └── TelegramProviderTest.php
  ├── Configuration/
  │   ├── Model/
  │   └── Test/
  │       └── Unit/
  │           └── Model/
  │               └── ConfigTest.php
  └── ...
```

### Именование тестов

Файлы тестов должны:
- Иметь суффикс `Test.php`
- Следовать той же структуре каталогов, что и тестируемые классы
- Использовать те же пространства имен с добавлением `\Test\Unit`

Например:
- Класс: `\Lachestry\Telegram\Model\TelegramClient`
- Тест: `\Lachestry\Telegram\Test\Unit\Model\TelegramClientTest`

## Написание тестов

### Базовая структура теста

```php
<?php
declare(strict_types=1);

namespace Lachestry\YourModule\Test\Unit\Model;

use PHPUnit\Framework\TestCase;
use Lachestry\YourModule\Model\YourClass;
// другие зависимости

class YourClassTest extends TestCase
{
    protected function setUp(): void
    {
        // Подготовка тестового окружения
    }

    public function testYourMethod(): void
    {
        // Arrange - подготовка данных
        // Act - выполнение действия
        // Assert - проверка результатов
    }
}
```

### Примеры тестов

#### Тест с моками

```php
public function testWithMocks(): void
{
    $mock = $this->createMock(Dependency::class);
    $mock->expects($this->once())
        ->method('someMethod')
        ->willReturn('expected result');

    $class = new YourClass($mock);
    $result = $class->testedMethod();

    $this->assertEquals('expected result', $result);
}
```

#### Тест обработки ошибок

```php
public function testErrorHandling(): void
{
    $this->expectException(\Exception::class);
    $this->expectExceptionMessage('Expected error message');

    $class = new YourClass();
    $class->methodThatThrowsException();
}
```

## Лучшие практики

1. **Изоляция тестов**
   - Каждый тест должен быть независимым
   - Используйте `setUp()` для подготовки общих данных
   - Очищайте состояние после каждого теста

2. **Именование тестов**
   - Используйте описательные имена
   - Включайте ожидаемый результат в имя теста
   - Следуйте единому стилю именования

3. **Обработка исключений**
   - Тестируйте как успешные сценарии, так и ошибки
   - Проверяйте сообщения исключений
   - Используйте `@expectedException` или `expectException()`

4. **Моки и стабы**
   - Используйте моки для внешних зависимостей
   - Минимизируйте количество моков в одном тесте
   - Проверяйте вызовы методов моков

5. **Утверждения**
   - Используйте наиболее специфичные утверждения
   - Проверяйте только один аспект в одном утверждении
   - Добавляйте информативные сообщения к утверждениям

## Проблемы и решения

### Тест не видит класс/зависимость

Проверьте, что:
- Класс существует и имеет правильное пространство имен
- Правильно настроен автозагрузчик
- Тестовый класс находится в правильной директории

### Тесты работают локально, но не в CI/CD

Проверьте:
- Версию PHP
- Зависимости проекта
- Переменные окружения

### Медленные тесты

Если тесты выполняются слишком долго:
- Используйте больше моков для замены реальных объектов
- Избегайте лишних операций в тестах
- Разделите тесты на группы для параллельного выполнения

## Интеграция с CI/CD

Автоматизированные тесты должны быть интегрированы в конвейер CI/CD для:
- Запуска тестов после каждого изменения
- Предотвращения слияния кода, не проходящего тесты
- Генерации отчетов о покрытии кода
- Отслеживания тенденций в качестве кода

## Ресурсы и документация

- [PHPUnit Documentation](https://phpunit.de/documentation.html)
- [Magento 2 Testing Guide](https://devdocs.magento.com/guides/v2.4/test/testing.html)